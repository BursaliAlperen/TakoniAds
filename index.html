Telegram Mini App: Reklam İzle ve Bitcoin Kazan

Aşağıda, istediğiniz tüm özelliklere sahip gelişmiş bir Telegram Mini App uygulamasını oluşturdum. Bu uygulama, Firebase Realtime Database kullanarak kullanıcıların reklam izleyerek Bitcoin (Sats) kazanmalarını ve Lightning Network üzerinden çekim yapmalarını sağlar.

Proje Yapısı

```
telegram-mini-app/
├── frontend/                 # React frontend
│   ├── src/
│   ├── public/
│   └── package.json
├── functions/                # Firebase Functions backend
│   ├── src/
│   └── package.json
└── database.rules.json       # Firebase Realtime Database kuralları
```

1. Firebase Realtime Database Kuralları (database.rules.json)

```json
{
  "rules": {
    "users": {
      "$userId": {
        ".read": "$userId === auth.uid",
        ".write": "$userId === auth.uid",
        "balance": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        },
        "lightningAddress": {
          ".validate": "newData.isString()"
        },
        "createdAt": {
          ".validate": "newData.isNumber()"
        },
        "lastWatchedAt": {
          ".validate": "newData.isNumber()"
        },
        "referrerId": {
          ".validate": "newData.isString()"
        },
        "referralCount": {
          ".validate": "newData.isNumber() && newData.val() >= 0"
        }
      }
    },
    "transactions": {
      "$userId": {
        "$txId": {
          ".read": "$userId === auth.uid",
          ".write": "$userId === auth.uid",
          ".validate": "newData.child('userId').val() === $userId"
        }
      }
    },
    "ads": {
      ".read": true,
      ".write": false,
      "$adId": {
        ".validate": "newData.child('active').isBoolean()"
      }
    }
  }
}
```

2. Backend - Firebase Functions (functions/src/index.ts)

```typescript
import * as functions from "firebase-functions";
import * as admin from "firebase-admin";
import * as express from "express";
import * as cors from "cors";

admin.initializeApp();
const db = admin.database();
const app = express();

app.use(cors({origin: true}));
app.use(express.json());

// JWT doğrulama middleware
const authenticate = async (req: any, res: any, next: any) => {
  try {
    const token = req.headers.authorization?.split("Bearer ")[1];
    if (!token) {
      return res.status(401).json({error: "Yetkilendirme gerekli"});
    }

    const decodedToken = await admin.auth().verifyIdToken(token);
    req.user = decodedToken;
    next();
  } catch (error) {
    res.status(401).json({error: "Geçersiz token"});
  }
};

// Kullanıcı kaydı
app.post("/register", async (req, res) => {
  try {
    const {userId, username, firstName, lastName, referrerId} = req.body;

    if (!userId) {
      return res.status(400).json({error: "Kullanıcı ID gerekli"});
    }

    const userRef = db.ref(`users/${userId}`);
    const userSnapshot = await userRef.once("value");

    // Kullanıcı zaten varsa
    if (userSnapshot.exists()) {
      const userData = userSnapshot.val();
      return res.json(userData);
    }

    // Yeni kullanıcı oluştur
    const newUser = {
      balance: 0,
      lightningAddress: "",
      createdAt: Date.now(),
      lastWatchedAt: 0,
      referrerId: referrerId || "",
      referralCount: 0,
      username,
      firstName,
      lastName
    };

    await userRef.set(newUser);

    // Referans varsa referans sahibine bonus ekle
    if (referrerId && referrerId !== userId) {
      const referrerRef = db.ref(`users/${referrerId}`);
      const referrerSnapshot = await referrerRef.once("value");
      
      if (referrerSnapshot.exists()) {
        await referrerRef.update({
          referralCount: admin.database.ServerValue.increment(1)
        });

        // Referans işlemini kaydet
        const referralTxRef = db.ref(`transactions/${referrerId}`).push();
        await referralTxRef.set({
          userId: referrerId,
          type: "referral_bonus",
          sats: 0, // İlk izlemede bonus verilecek
          status: "pending",
          createdAt: Date.now(),
          referredUser: userId
        });
      }
    }

    res.json(newUser);
  } catch (error) {
    console.error("Register error:", error);
    res.status(500).json({error: "Sunucu hatası"});
  }
});

// Reklam izleme
app.post("/watch-ad", authenticate, async (req, res) => {
  try {
    const userId = req.user.uid;
    const {adId} = req.body;

    if (!adId) {
      return res.status(400).json({error: "Reklam ID gerekli"});
    }

    // Reklam bilgilerini al
    const adRef = db.ref(`ads/${adId}`);
    const adSnapshot = await adRef.once("value");
    
    if (!adSnapshot.exists() || !adSnapshot.val().active) {
      return res.status(400).json({error: "Geçersiz reklam"});
    }

    const ad = adSnapshot.val();

    // Cooldown kontrolü (30 saniye)
    const userRef = db.ref(`users/${userId}`);
    const userSnapshot = await userRef.once("value");
    const user = userSnapshot.val();

    if (Date.now() - user.lastWatchedAt < 30000) {
      return res.status(400).json({error: "Lütfen 30 saniye bekleyin"});
    }

    // Ödülü hesapla
    let reward = ad.reward;

    // Referans bonusu (ilk işlemde)
    let referralBonus = 0;
    if (user.referrerId && user.referralCount === 0) {
      referralBonus = Math.floor(reward * 0.10); // %10 bonus
      
      // Referans sahibine bonus ekle
      const referrerRef = db.ref(`users/${user.referrerId}`);
      await referrerRef.update({
        balance: admin.database.ServerValue.increment(referralBonus)
      });

      // Referans bonus işlemini kaydet
      const referralTxRef = db.ref(`transactions/${user.referrerId}`).push();
      await referralTxRef.set({
        userId: user.referrerId,
        type: "referral_bonus",
        sats: referralBonus,
        status: "completed",
        createdAt: Date.now(),
        referredUser: userId
      });
    }

    // Kullanıcı bakiyesini güncelle
    await userRef.update({
      balance: admin.database.ServerValue.increment(reward),
      lastWatchedAt: Date.now(),
      referralCount: admin.database.ServerValue.increment(1)
    });

    // İşlemi kaydet
    const txRef = db.ref(`transactions/${userId}`).push();
    await txRef.set({
      userId,
      type: "ad_watch",
      sats: reward,
      status: "completed",
      createdAt: Date.now(),
      adId,
      referralBonus
    });

    res.json({
      success: true,
      reward,
      referralBonus,
      newBalance: user.balance + reward
    });

  } catch (error) {
    console.error("Watch ad error:", error);
    res.status(500).json({error: "Sunucu hatası"});
  }
});

// Çekim işlemi
app.post("/withdraw", authenticate, async (req, res) => {
  try {
    const userId = req.user.uid;
    const {lightningAddress, amount} = req.body;

    if (!lightningAddress || !amount) {
      return res.status(400).json({error: "Lightning adresi ve miktar gerekli"});
    }

    if (amount < 100) {
      return res.status(400).json({error: "Minimum çekim: 100 sats"});
    }

    // Kullanıcı bakiyesini kontrol et
    const userRef = db.ref(`users/${userId}`);
    const userSnapshot = await userRef.once("value");
    const user = userSnapshot.val();

    if (user.balance < amount) {
      return res.status(400).json({error: "Yetersiz bakiye"});
    }

    // LNbits API ile ödeme yap
    const LNBITS_URL = functions.config().lnbits.url;
    const LNBITS_KEY = functions.config().lnbits.key;

    const paymentResponse = await fetch(`${LNBITS_URL}/api/v1/payments`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-Api-Key": LNBITS_KEY
      },
      body: JSON.stringify({
        out: true,
        bolt11: lightningAddress,
        amount: amount
      })
    });

    if (!paymentResponse.ok) {
      throw new Error("Ödeme hatası");
    }

    const paymentResult = await paymentResponse.json();

    // Bakiyeyi güncelle
    await userRef.update({
      balance: admin.database.ServerValue.increment(-amount),
      lightningAddress: lightningAddress
    });

    // İşlemi kaydet
    const txRef = db.ref(`transactions/${userId}`).push();
    await txRef.set({
      userId,
      type: "withdrawal",
      sats: -amount,
      status: "completed",
      createdAt: Date.now(),
      lightningAddress,
      paymentId: paymentResult.payment_hash
    });

    res.json({
      success: true,
      paymentHash: paymentResult.payment_hash,
      newBalance: user.balance - amount
    });

  } catch (error) {
    console.error("Withdraw error:", error);
    res.status(500).json({error: "Çekim hatası"});
  }
});

// Reklamları getir
app.get("/ads", async (req, res) => {
  try {
    const adsRef = db.ref("ads");
    const snapshot = await adsRef.once("value");
    const ads: any[] = [];
    
    snapshot.forEach((childSnapshot) => {
      const ad = childSnapshot.val();
      if (ad.active) {
        ads.push({
          id: childSnapshot.key,
          ...ad
        });
      }
    });

    res.json(ads);
  } catch (error) {
    console.error("Get ads error:", error);
    res.status(500).json({error: "Sunucu hatası"});
  }
});

exports.api = functions.https.onRequest(app);
```

3. Frontend - React (frontend/src/App.tsx)

```typescript
import React, { useEffect, useState } from 'react';
import { initializeApp } from 'firebase/app';
import { getDatabase, ref, onValue, off } from 'firebase/database';
import { getAuth, signInWithCustomToken } from 'firebase/auth';
import './App.css';

// Firebase konfigürasyonu
const firebaseConfig = {
  apiKey: "your-api-key",
  authDomain: "your-project.firebaseapp.com",
  databaseURL: "https://your-project.firebasedatabase.app",
  projectId: "your-project",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "123456789",
  appId: "your-app-id"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const auth = getAuth(app);

interface User {
  balance: number;
  lightningAddress: string;
  createdAt: number;
  lastWatchedAt: number;
  referrerId: string;
  referralCount: number;
  username?: string;
  firstName?: string;
  lastName?: string;
}

interface Transaction {
  type: string;
  sats: number;
  status: string;
  createdAt: number;
  adId?: string;
  referralBonus?: number;
  lightningAddress?: string;
}

interface Ad {
  id: string;
  title: string;
  url: string;
  reward: number;
  active: boolean;
}

function App() {
  const [user, setUser] = useState<User | null>(null);
  const [transactions, setTransactions] = useState<Transaction[]>([]);
  const [ads, setAds] = useState<Ad[]>([]);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [withdrawAmount, setWithdrawAmount] = useState('');
  const [lightningAddress, setLightningAddress] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  // Telegram WebApp başlatma
  useEffect(() => {
    const tg = (window as any).Telegram?.WebApp;
    if (tg) {
      tg.ready();
      tg.expand();
      
      // Firebase authentication için custom token al
      initializeUser(tg);
    }
  }, []);

  const initializeUser = async (tg: any) => {
    try {
      const userData = tg.initDataUnsafe?.user;
      if (!userData) return;

      // Backend'den custom token al
      const response = await fetch('/api/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId: userData.id.toString(),
          username: userData.username,
          firstName: userData.first_name,
          lastName: userData.last_name,
          referrerId: getReferrerId()
        })
      });

      const result = await response.json();
      
      if (result.token) {
        // Firebase ile giriş yap
        await signInWithCustomToken(auth, result.token);
        setupRealtimeListeners(userData.id.toString());
      }
      
      setUser(result);
    } catch (error) {
      console.error('Kullanıcı başlatma hatası:', error);
    }
  };

  const getReferrerId = () => {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get('start') || '';
  };

  const setupRealtimeListeners = (userId: string) => {
    // Kullanıcı verilerini dinle
    const userRef = ref(database, `users/${userId}`);
    onValue(userRef, (snapshot) => {
      setUser(snapshot.val());
    });

    // İşlem geçmişini dinle
    const transactionsRef = ref(database, `transactions/${userId}`);
    onValue(transactionsRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        const txList = Object.values(data) as Transaction[];
        setTransactions(txList.sort((a, b) => b.createdAt - a.createdAt));
      }
    });

    // Reklamları yükle
    loadAds();
  };

  const loadAds = async () => {
    try {
      const response = await fetch('/api/ads');
      const adsData = await response.json();
      setAds(adsData);
    } catch (error) {
      console.error('Reklam yükleme hatası:', error);
    }
  };

  const watchAd = async (adId: string) => {
    if (isLoading) return;
    
    setIsLoading(true);
    try {
      const token = await auth.currentUser?.getIdToken();
      const response = await fetch('/api/watch-ad', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ adId })
      });

      const result = await response.json();
      if (!response.ok) throw new Error(result.error);

      // Başarı mesajı göster
      showNotification(`🎉 ${result.reward} sats kazandınız!`);
    } catch (error: any) {
      showNotification(`❌ ${error.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  const handleWithdraw = async () => {
    if (!lightningAddress || !withdrawAmount) {
      showNotification('Lütfen tüm alanları doldurun');
      return;
    }

    const amount = parseInt(withdrawAmount);
    if (amount < 100) {
      showNotification('Minimum çekim: 100 sats');
      return;
    }

    if (!user || user.balance < amount) {
      showNotification('Yetersiz bakiye');
      return;
    }

    setIsLoading(true);
    try {
      const token = await auth.currentUser?.getIdToken();
      const response = await fetch('/api/withdraw', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({
          lightningAddress,
          amount
        })
      });

      const result = await response.json();
      if (!response.ok) throw new Error(result.error);

      showNotification('✅ Çekim başarıyla gönderildi!');
      setWithdrawAmount('');
    } catch (error: any) {
      showNotification(`❌ ${error.message}`);
    } finally {
      setIsLoading(false);
    }
  };

  const showNotification = (message: string) => {
    const tg = (window as any).Telegram?.WebApp;
    if (tg) {
      tg.showPopup({
        title: 'Bildirim',
        message: message,
        buttons: [{ type: 'ok' }]
      });
    } else {
      alert(message);
    }
  };

  const getReferralLink = () => {
    const tg = (window as any).Telegram?.WebApp;
    const botUsername = 'your_bot_username'; // Bot kullanıcı adınız
    const userId = tg?.initDataUnsafe?.user?.id;
    
    return userId ? `https://t.me/${botUsername}?start=${userId}` : '';
  };

  if (!user) {
    return (
      <div className="splash-screen">
        <div className="logo">₿</div>
        <h1>BitAd</h1>
        <p>Reklam İzle, Bitcoin Kazan</p>
      </div>
    );
  }

  return (
    <div className="app">
      {/* Header */}
      <header className="header">
        <div className="balance-card">
          <div className="balance-label">Bakiyeniz</div>
          <div className="balance-amount">{user.balance} sats</div>
        </div>
        
        <div className="referral-stats">
          <div className="stat">
            <span className="stat-label">Referanslar</span>
            <span className="stat-value">{user.referralCount}</span>
          </div>
        </div>
      </header>

      {/* Navigation */}
      <nav className="navigation">
        <button 
          className={`nav-btn ${activeTab === 'dashboard' ? 'active' : ''}`}
          onClick={() => setActiveTab('dashboard')}
        >
          🏠 Pano
        </button>
        <button 
          className={`nav-btn ${activeTab === 'withdraw' ? 'active' : ''}`}
          onClick={() => setActiveTab('withdraw')}
        >
          💰 Çekim
        </button>
        <button 
          className={`nav-btn ${activeTab === 'history' ? 'active' : ''}`}
          onClick={() => setActiveTab('history')}
        >
          📜 Geçmiş
        </button>
      </nav>

      {/* Main Content */}
      <main className="main-content">
        {/* Dashboard */}
        {activeTab === 'dashboard' && (
          <div className="tab-content">
            <div className="referral-section">
              <h3>Referans Linkiniz</h3>
              <div className="referral-link">
                <input 
                  type="text" 
                  value={getReferralLink()} 
                  readOnly 
                  className="link-input"
                />
                <button 
                  onClick={() => navigator.clipboard.writeText(getReferralLink())}
                  className="copy-btn"
                >
                  Kopyala
                </button>
              </div>
              <p className="referral-info">
                Her referans için %10 bonus kazanın!
              </p>
            </div>

            <div className="ads-section">
              <h3>Reklamlar</h3>
              <div className="ads-grid">
                {ads.map(ad => (
                  <div key={ad.id} className="ad-card">
                    <h4>{ad.title}</h4>
                    <p>Ödül: {ad.reward} sats</p>
                    <button 
                      onClick={() => watchAd(ad.id)}
                      disabled={isLoading}
                      className="watch-btn"
                    >
                      {isLoading ? 'İzleniyor...' : 'İzle & Kazan'}
                    </button>
                  </div>
                ))}
              </div>
            </div>
          </div>
        )}

        {/* Withdraw */}
        {activeTab === 'withdraw' && (
          <div className="tab-content">
            <div className="withdraw-form">
              <h3>Bitcoin Çekimi</h3>
              
              <div className="form-group">
                <label>Lightning Adresi</label>
                <input 
                  type="text" 
                  value={lightningAddress}
                  onChange={(e) => setLightningAddress(e.target.value)}
                  placeholder="kullanici@lnprovider.com"
                  className="form-input"
                />
              </div>

              <div className="form-group">
                <label>Miktar (sats)</label>
                <input 
                  type="number" 
                  value={withdrawAmount}
                  onChange={(e) => setWithdrawAmount(e.target.value)}
                  placeholder="100"
                  min="100"
                  max={user.balance}
                  className="form-input"
                />
              </div>

              <div className="withdraw-info">
                <p>• Minimum çekim: 100 sats</p>
                <p>• Çekim ücreti: 1%</p>
                <p>• Mevcut bakiye: {user.balance} sats</p>
              </div>

              <button 
                onClick={handleWithdraw}
                disabled={isLoading}
                className="withdraw-btn"
              >
                {isLoading ? 'İşleniyor...' : 'Çekim Yap'}
              </button>
            </div>
          </div>
        )}

        {/* History */}
        {activeTab === 'history' && 
