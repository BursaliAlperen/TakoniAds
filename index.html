<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashReward App</title>
    
    <!-- Your Ad Code -->
    <script src='//libtl.com/sdk.js' data-zone='9391539' data-sdk='show_9391539'></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #1a1a1a; color: #ffffff; }
        .main-bg { background-color: #1a1a1a; }
        .card-bg { background-color: #2c2c2c; }
        .input-field { background-color: #3f3f46; border: 1px solid #52525b; }
        .accent-yellow { color: #facc15; }
        .accent-yellow-bg { background-color: #facc15; }
        .btn, .btn-accent { transition: all 0.2s ease-in-out; transform: scale(1); border-radius: 9999px; }
        .btn:active, .btn-accent:active { transform: scale(0.95); }
        .btn-accent { background-color: #facc15; color: #1a1a1a; font-weight: bold; }
        .btn-accent:hover { background-color: #eab308; }
        .btn-accent[disabled] { background-color: #4a4a4a; color: #888; cursor: not-allowed; }
        .main-page { display: none; }
        .main-page.active { display: flex; animation: fadeIn 0.5s ease-in-out; }
        .sub-page { display: none; }
        .sub-page.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        .bottom-nav { background: #2c2c2c; border-top: 1px solid #444; }
        .bottom-nav a { color: #a1a1aa; transition: color 0.3s ease; }
        .bottom-nav a.active { color: #facc15; }
        .bottom-nav a.active .nav-indicator { width: 24px; height: 4px; background-color: #facc15; border-radius: 2px; margin: 4px auto 0; }
        .feature-btn { background-color: #facc15; border-radius: 1.5rem; padding: 1.5rem; color: #1a1a1a; font-weight: 700; text-align: center; box-shadow: 0 5px 0 #ca8a04; transition: all 0.1s ease-in-out; position: relative; top: 0; cursor: pointer; }
        .feature-btn:active { box-shadow: 0 2px 0 #ca8a04; top: 3px; }
        .feature-btn svg, .feature-btn img { filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3)); }
        #slider-container { overflow: hidden; position: relative; aspect-ratio: 16/7; border-radius: 1rem;}
        .slider-wrapper { display: flex; transition: transform 0.5s ease-in-out; }
        .slider-item { min-width: 100%; box-sizing: border-box; }
        .slider-item img { width: 100%; height: 100%; object-fit: cover; }
        .slider-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
        .slider-dot { width: 8px; height: 8px; background-color: rgba(255, 255, 255, 0.5); border-radius: 50%; cursor: pointer; transition: background-color 0.3s; }
        .slider-dot.active { background-color: white; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="max-w-md mx-auto">

    <!-- Loader -->
    <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50"><div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-yellow-400"></div></div>

    <!-- Auth Section -->
    <div id="auth-section" class="min-h-screen p-6 flex-col justify-center main-page main-bg">
        <h1 class="text-5xl font-extrabold text-center mb-2 accent-yellow">CashReward</h1>
        <p class="text-center text-gray-400 mb-8">Login or Signup to continue</p>
        <div id="auth-container">
            <div id="login-view">
                <input id="login-email" type="email" placeholder="Email" class="w-full p-3 rounded-lg input-field mb-4">
                <input id="login-password" type="password" placeholder="Password" class="w-full p-3 rounded-lg input-field mb-4">
                <button id="login-btn" class="w-full p-3 btn-accent mb-4">Login</button>
                <p class="text-center text-gray-400">No account? <a href="#" id="show-signup" class="font-semibold accent-yellow">Sign Up</a></p>
            </div>
            <div id="signup-view" class="hidden">
                <input id="signup-name" type="text" placeholder="Full Name" class="w-full p-3 rounded-lg input-field mb-4">
                <input id="signup-email" type="email" placeholder="Email" class="w-full p-3 rounded-lg input-field mb-4">
                <input id="signup-password" type="password" placeholder="Password" class="w-full p-3 rounded-lg input-field mb-4">
                <button id="signup-btn" class="w-full p-3 btn-accent mb-4">Sign Up</button>
                <p class="text-center text-gray-400">Already have an account? <a href="#" id="show-login" class="font-semibold accent-yellow">Login</a></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-container" class="min-h-screen flex-col main-page main-bg">
        <header class="p-4 flex items-center justify-between"><div class="flex items-center space-x-3"><img src="https://placehold.co/50x50/facc15/1a1a1a?text=A" id="profile-picture" class="rounded-full border-2 border-yellow-400"><div><h2 class="font-semibold text-lg leading-tight" id="header-profile-name">Hi, Anonymously</h2><p class="text-gray-400 text-sm leading-tight">Welcome</p></div></div><div class="accent-yellow-bg text-black px-4 py-2 rounded-full font-bold flex items-center space-x-2"><span id="header-coin-balance">0</span><i data-lucide="coins" class="w-5 h-5"></i></div></header>
        <main class="flex-grow">
            <div id="back-button-container" class="hidden p-4"><button onclick="navigateTo('home-page')" class="flex items-center accent-yellow"><i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i><span>Back to Home</span></button></div>
            
            <div id="home-page" class="p-4 space-y-6 sub-page">
                <div id="slider-container"><div class="slider-wrapper"></div><div class="slider-dots"></div></div>
                <div class="grid grid-cols-2 gap-5">
                    <div onclick="navigateTo('color-game-page')" class="feature-btn"><svg class="w-12 h-12 mx-auto mb-2" viewBox="0 0 64 64" fill="#1a1a1a" xmlns="http://www.w3.org/2000/svg"><path d="M32 4C16.5 4 4 16.5 4 32S16.5 60 32 60 60 47.5 60 32 47.5 4 32 4zm0 52C18.8 56 8 45.2 8 32S18.8 8 32 8s24 10.8 24 24-10.8 24-24 24z"/><path d="M32 14c-9.9 0-18 8.1-18 18s8.1 18 18 18V14z"/></svg><span class="text-lg">Color Game</span></div>
                    <div onclick="claimReward()" class="feature-btn"><svg class="w-12 h-12 mx-auto mb-2" viewBox="0 0 64 64" fill="#1a1a1a" xmlns="http://www.w3.org/2000/svg"><path d="M56 16.2v31.6c0 1.1-.9 2-2 2H10c-1.1 0-2-.9-2-2V16.2c0-1.1.9-2 2-2h44c1.1 0 2 .9 2 2zM12 18.2v27.6h40V18.2H12z"/><path d="M25.8 41.5l14-9.3-14-9.3v18.6z"/></svg><span class="text-lg">Watch & Earn</span></div>
                    <div onclick="navigateTo('visit-earn-page')" class="feature-btn"><svg class="w-12 h-12 mx-auto mb-2" viewBox="0 0 64 64" fill="#1a1a1a" xmlns="http://www.w3.org/2000/svg"><path d="M32 12C20.9 12 12 20.9 12 32s8.9 20 20 20 20-8.9 20-20-8.9-20-20-20zm0 36c-8.8 0-16-7.2-16-16s7.2-16 16-16 16 7.2 16 16-7.2 16-16 16z"/><circle cx="32" cy="32" r="8"/></svg><span class="text-lg">View & Win</span></div>
                    <div onclick="navigateTo('social-tasks-page')" class="feature-btn"><svg class="w-12 h-12 mx-auto mb-2" viewBox="0 0 64 64" fill="#1a1a1a" xmlns="http://www.w3.org/2000/svg"><path d="M52 12H12c-2.2 0-4 1.8-4 4v24c0 2.2 1.8 4 4 4h12v8l8-8h16c2.2 0 4-1.8 4-4V16c0-2.2-1.8-4-4-4zm-4 28H30l-4 4v-4H12V16h36v24z"/><path d="M22 24h20v4H22zm0 8h12v4H22z"/></svg><span class="text-lg">Social Tasks</span></div>
                </div>
            </div>
            
            <div id="color-game-page" class="p-4 space-y-4 text-center sub-page"></div>
            <div id="visit-earn-page" class="p-4 space-y-4 sub-page"></div>
            <div id="social-tasks-page" class="p-4 space-y-4 sub-page"></div>
            <div id="wallet-page" class="p-4 space-y-6 sub-page"></div>
            <div id="refer-page" class="p-4 space-y-6 sub-page"></div>
            <div id="profile-page" class="p-4 space-y-6 sub-page"></div>
        </main>
        <nav class="bottom-nav sticky bottom-0 grid grid-cols-4 items-center text-center py-2 rounded-t-2xl">
            <a href="#" class="nav-link active" data-page="home-page"><i data-lucide="home" class="mx-auto w-7 h-7"></i><div class="nav-indicator"></div></a>
            <a href="#" class="nav-link" data-page="refer-page"><i data-lucide="users" class="mx-auto w-7 h-7"></i><div class="nav-indicator"></div></a>
            <a href="#" class="nav-link" data-page="wallet-page"><i data-lucide="wallet" class="mx-auto w-7 h-7"></i><div class="nav-indicator"></div></a>
            <a href="#" class="nav-link" data-page="profile-page"><i data-lucide="user" class="mx-auto w-7 h-7"></i><div class="nav-indicator"></div></a>
        </nav>
    </div>
    
    <!-- Popups -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="card-bg rounded-lg p-6 w-full max-w-sm text-center">
            <p id="alert-message" class="mb-4"></p>
            <button id="alert-ok-btn" class="btn-accent px-6 py-2">OK</button>
        </div>
    </div>
    <div id="color-game-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"></div>
    <div id="special-ad-popup" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"></div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "apna code dale",
            authDomain: "apna code dale",
            projectId: "apna code dale",
            storageBucket: "apna code dale",
            messagingSenderId: "apna code dale",
            appId: "apna code dale"
        };
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let appConfig = {};
        let sliderInterval;

        const loader = document.getElementById('loader');
        const backButtonContainer = document.getElementById('back-button-container');

        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            showMainPage('auth-section'); // Start with auth page
            onAuthStateChanged(auth, handleAuthStateChange);
        };
        
        async function handleAuthStateChange(user) {
            loader.style.display = 'flex';
            if (user) {
                currentUser = user;
                await fetchAppConfig();
                await fetchUserData();
                if (userData.isBlocked) {
                    showAlert("Your account has been blocked.");
                    await signOut(auth);
                    loader.style.display = 'none'; return;
                }
                populateAllPages();
                await resetDailyTasksIfNeeded();
                updateAllUI();
                initSlider();
                showMainPage('app-container');
                navigateTo('home-page');
            } else {
                currentUser = null; userData = null;
                showMainPage('auth-section');
            }
            loader.style.display = 'none';
        }

        function populateAllPages() {
            document.getElementById('color-game-popup').innerHTML = `<div class="card-bg rounded-lg p-6 w-full max-w-sm text-center space-y-4"><h3 class="text-xl font-bold">Correct Answer!</h3><p>Bravo! Watch an ad to claim ${appConfig.colorGameReward || 10} coins.</p><div class="flex justify-center space-x-4"><button id="claim-color-reward-btn" class="btn-accent px-6 py-2">Claim</button><button onclick="document.getElementById('color-game-popup').classList.add('hidden'); startGame()" class="bg-gray-600 text-white px-6 py-2 rounded-full">Later</button></div></div>`;
            document.getElementById('special-ad-popup').innerHTML = `<div class="card-bg rounded-lg p-6 w-full max-w-sm text-center space-y-4"><h3 class="text-xl font-bold accent-yellow">Special Bonus!</h3><div class="text-left space-y-2"><p>1. Click 'Watch Ad'.</p><p>2. **Click** on the ad that appears.</p><p>3. Wait for <span id="special-ad-timer-total">60</span> seconds on the website.</p><p>4. Come back to claim your coins.</p></div><div id="special-ad-status" class="text-center font-semibold my-2"></div><button id="show-special-ad-btn" class="btn-accent w-full p-3">Watch Ad</button><div id="special-ad-timer-container" class="hidden"><p class="text-lg">Waiting... <span id="special-ad-timer">60</span>s</p></div><button id="claim-special-ad-final-btn" class="hidden btn-accent w-full p-3">Claim Bonus</button></div>`;
            document.getElementById('color-game-page').innerHTML = `<h2 class="text-2xl font-bold">Guess the Color!</h2><p class="text-gray-400">Pick the box with the matching color.</p><div class="card-bg p-4 rounded-lg"><p>Find this color:</p><div id="target-color-box" class="w-24 h-12 mx-auto rounded-lg my-2 border-2 border-white"></div><p id="target-color-rgb" class="font-mono"></p></div><div id="color-options-grid" class="grid grid-cols-3 gap-4 max-w-sm mx-auto"></div>`;
            document.getElementById('visit-earn-page').innerHTML = `<h2 class="text-2xl font-bold text-center">Visit & Earn</h2><div id="website-list" class="space-y-3 mt-4"></div>`;
            document.getElementById('social-tasks-page').innerHTML = `<h2 class="text-2xl font-bold text-center">Social Tasks</h2><div id="social-tasks-list" class="space-y-3 mt-4"></div>`;
            document.getElementById('wallet-page').innerHTML = `<h2 class="text-xl font-bold text-center">My Wallet</h2><div class="card-bg p-4 rounded-lg"><p class="text-sm text-gray-400 mb-1">Balance: <span class="font-bold accent-yellow" id="wallet-coin-balance">0</span> Coins</p><p class="text-sm text-gray-400 mb-4" id="coin-value-info"></p><input id="withdraw-amount" type="number" placeholder="Coin amount" class="w-full p-3 rounded-lg input-field mb-3"><select id="withdraw-method" class="w-full p-3 rounded-lg input-field mb-3"></select><div id="payment-details-container"></div><button id="withdraw-btn" class="w-full p-3 btn-accent mt-3">Request Withdrawal</button></div><div><h3 class="text-lg font-semibold my-3">Withdrawal History</h3><div id="withdrawal-history-list" class="space-y-3"></div></div>`;
            document.getElementById('refer-page').innerHTML = `<h2 class="text-xl font-bold text-center">Refer & Earn</h2><div class="card-bg p-6 rounded-lg text-center mt-4"><p id="referral-bonus-info" class="text-lg mb-4"></p><p class="text-gray-400 mb-2">Your Referral Code</p><div class="bg-gray-800 p-3 rounded-lg flex items-center justify-center mb-4"><span id="referral-code" class="text-2xl font-bold tracking-widest">...</span><button id="copy-code-btn" class="ml-4"><i data-lucide="copy" class="w-6 h-6 text-gray-400"></i></button></div><div id="referral-rules-container" class="mt-4 text-left"></div></div><button id="share-btn" class="w-full p-3 btn-accent mt-4">Share Code</button><div class="card-bg p-4 rounded-lg mt-6"><h3 class="font-semibold mb-3 text-center">Have a code? Enter it here.</h3><input id="enter-referral-code" type="text" placeholder="Enter code here" class="w-full p-3 rounded-lg input-field mb-3"><button id="apply-referral-btn" class="w-full p-3 bg-gray-600 text-white rounded-full">Apply Code</button></div>`;
            document.getElementById('profile-page').innerHTML = `<h2 class="text-xl font-bold text-center mb-4">Profile</h2><div class="flex flex-col items-center card-bg p-6 rounded-lg"><img src="https://placehold.co/100x100/1e1e1e/facc15?text=U" id="profile-page-picture" class="rounded-full mb-2 w-24 h-24"><h2 id="profile-page-name" class="text-xl font-bold">User Name</h2><p id="profile-page-email" class="text-gray-400">user@email.com</p></div><button id="logout-btn" class="w-full mt-6 p-3 rounded-full bg-red-600 text-white font-bold">Logout</button>`;
        }

        async function fetchUserData() {
            if (!currentUser) return;
            const userRef = doc(db, "users", currentUser.uid);
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) { userData = userSnap.data(); } 
            else {
                const ownReferralCode = Math.random().toString(36).substring(2, 8).toUpperCase();
                const defaultUserData = { uid: currentUser.uid, name: currentUser.displayName || currentUser.email.split('@')[0], email: currentUser.email, balance: 50, referralCode: ownReferralCode, referredBy: null, createdAt: serverTimestamp(), isBlocked: false, dailyAdCount: 0, lastAdWatchDate: '1970-01-01', visitedWebsitesToday: [], lastWebsiteVisitDate: '1970-01-01', completedSocialTasks: [] };
                await setDoc(doc(db, "users", currentUser.uid), defaultUserData);
                userData = defaultUserData;
            }
        }

        async function fetchAppConfig() {
            const configRef = doc(db, "config", "main");
            const configSnap = await getDoc(configRef);
            appConfig = configSnap.exists() ? configSnap.data() : { 
                referralRules: ["Your friend must sign up.", "Bonus is credited after they apply the code."],
                referralShareText: "Join CashReward and earn money! Use my code {CODE} to get a bonus. App link: {APP_LINK}",
                watchAdSpecialTaskCount: 10, watchAdSpecialTaskReward: 100, watchAdSpecialTaskTimer: 60, 
                paymentMethods: ["UPI", "Paytm", "PayPal"] // Simplified to one list
            };
        }
        
        async function resetDailyTasksIfNeeded() {
            const today = new Date().toISOString().split('T')[0];
            let updates = {};
            if (userData.lastAdWatchDate !== today) { updates.lastAdWatchDate = today; updates.dailyAdCount = 0; }
            if (userData.lastWebsiteVisitDate !== today) { updates.lastWebsiteVisitDate = today; updates.visitedWebsitesToday = []; }
            if (Object.keys(updates).length > 0) {
                await updateDoc(doc(db, "users", currentUser.uid), updates);
                userData = { ...userData, ...updates };
            }
        }
        
        function updateAllUI() {
            if (!userData) return;
            const name = userData.name || 'Anonymously';
            document.getElementById('header-profile-name').textContent = `Hi, ${name}`;
            document.getElementById('header-coin-balance').textContent = userData.balance || 0;
            document.getElementById('profile-picture').src = `https://placehold.co/50x50/facc15/1a1a1a?text=${name.charAt(0).toUpperCase()}`;
        }
        
        function initSlider() {
            const sliderContainer = document.getElementById('slider-container');
            const wrapper = sliderContainer.querySelector('.slider-wrapper');
            const dotsContainer = sliderContainer.querySelector('.slider-dots');
            wrapper.innerHTML = ''; dotsContainer.innerHTML = '';
            const banners = appConfig.sliderBanners || [];
            if (banners.length === 0) { sliderContainer.sty  document.getElementById('userSection').style.display = 'block';
  document.getElementById('userEmail').innerText = user.email;

  const userRef = db.ref('users/' + user.uid);
  userRef.on('value', snap => {
    document.getElementById('userBalance').innerText = ((snap.val()||{}).coins||0).toFixed(6) + " TON";
  });

  if(adminUIDs.includes(user.uid)) {
    document.getElementById('adminSection').style.display = 'block';
    document.getElementById('adminStatus').innerText = 'Admin girişi başarılı: ' + user.uid;
    loadWithdrawals();
    loadAnalytics();
  }
}

// Tap & Earn
function tapToEarn() {
  const user = auth.currentUser;
  if(!user) return alert('Giriş yapmadınız!');
  const userRef = db.ref('users/' + user.uid);
  userRef.transaction(current => {
    if(!current) return {coins:0.0005};
    current.coins = (current.coins||0)+0.0005;
    return current;
  });
}

// Admin Withdrawal
function loadWithdrawals() {
  db.ref('withdrawals').on('value', snap => {
    const tbody = document.getElementById('adminTableBody');
    tbody.innerHTML = '';
    snap.forEach(s => {
      const w = s.val();
      if(w.status==='Pending'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${w.userId}</td><td>${w.walletAddress}</td><td>${w.amount.toFixed(6)}</td><td>${w.status}</td>
        <td>
          <button class="approve" onclick="approve('${s.key}', ${w.amount}, '${w.userId}')">Approve</button>
          <button class="reject" onclick="reject('${s.key}')">Reject</button>
        </td>`;
        tbody.appendChild(tr);
      }
    });
  });
}

function approve(id, amount, userId){
  db.ref('users/'+userId).transaction(current=>{
    if(current) current.coins=(current.coins||0)-amount;
    return current;
  });
  db.ref('withdrawals/'+id).update({status:'Approved'});
}

function reject(id){
  db.ref('withdrawals/'+id).update({status:'Rejected'});
}

// Analytics Chart
function loadAnalytics() {
  db.ref('users').once('value').then(snapshot=>{
    const labels=[], coins=[], refs=[];
    snapshot.forEach(s=>{
      labels.push(s.key);
      coins.push((s.val().coins||0));
      db.ref('reffers/'+s.key).once('value').then(r=>{
        refs.push(r.exists()?Object.keys(r.val()).length:0);
        if(coins.length===labels.length && refs.length===labels.length){
          renderChart(labels, coins, refs);
        }
      });
    });
  });
}

function renderChart(labels, coins, refs){
  const ctx=document.getElementById('analyticsChart').getContext('2d');
  new Chart(ctx,{
    type:'bar',
    data:{labels:labels,datasets:[
      {label:'Coins', data:coins, backgroundColor:'#ffcc00'},
      {label:'Referrals', data:refs, backgroundColor:'#4caf50'}
    ]},
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  });
}
</script>

</body>
</html>  document.getElementById('userEmail').innerText = user.email;

  const userRef = db.ref('users/' + user.uid);
  userRef.on('value', snap => {
    document.getElementById('userBalance').innerText = ((snap.val()||{}).coins||0).toFixed(6) + " TON";
  });

  if(adminUIDs.includes(user.uid)) {
    document.getElementById('adminSection').style.display = 'block';
    document.getElementById('adminStatus').innerText = 'Admin girişi başarılı: ' + user.uid;
    loadWithdrawals();
    loadAnalytics();
  }
}

// Tap & Earn
function tapToEarn() {
  const user = auth.currentUser;
  if(!user) return alert('Giriş yapmadınız!');
  const userRef = db.ref('users/' + user.uid);
  userRef.transaction(current => {
    if(!current) return {coins:0.0005};
    current.coins = (current.coins||0)+0.0005;
    return current;
  });
}

// Admin Withdrawal
function loadWithdrawals() {
  db.ref('withdrawals').on('value', snap => {
    const tbody = document.getElementById('adminTableBody');
    tbody.innerHTML = '';
    snap.forEach(s => {
      const w = s.val();
      if(w.status==='Pending'){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${w.userId}</td><td>${w.walletAddress}</td><td>${w.amount.toFixed(6)}</td><td>${w.status}</td>
        <td>
          <button class="approve" onclick="approve('${s.key}', ${w.amount}, '${w.userId}')">Approve</button>
          <button class="reject" onclick="reject('${s.key}')">Reject</button>
        </td>`;
        tbody.appendChild(tr);
      }
    });
  });
}

function approve(id, amount, userId){
  db.ref('users/'+userId).transaction(current=>{
    if(current) current.coins=(current.coins||0)-amount;
    return current;
  });
  db.ref('withdrawals/'+id).update({status:'Approved'});
}

function reject(id){
  db.ref('withdrawals/'+id).update({status:'Rejected'});
}

// Analytics Chart
function loadAnalytics() {
  db.ref('users').once('value').then(snapshot=>{
    const labels=[], coins=[], refs=[];
    snapshot.forEach(s=>{
      labels.push(s.key);
      coins.push((s.val().coins||0));
      db.ref('reffers/'+s.key).once('value').then(r=>{
        refs.push(r.exists()?Object.keys(r.val()).length:0);
        if(coins.length===labels.length && refs.length===labels.length){
          renderChart(labels, coins, refs);
        }
      });
    });
  });
}

function renderChart(labels, coins, refs){
  const ctx=document.getElementById('analyticsChart').getContext('2d');
  new Chart(ctx,{
    type:'bar',
    data:{labels:labels,datasets:[
      {label:'Coins', data:coins, backgroundColor:'#ffcc00'},
      {label:'Referrals', data:refs, backgroundColor:'#4caf50'}
    ]},
    options:{responsive:true, scales:{y:{beginAtZero:true}}}
  });
}
</script>

</body>
  </html>
