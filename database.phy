<?php
class Database {
    private $pdo;

    public function __construct() {
        $dsn = getenv('DB_DSN') ?: 'mysql:host=localhost;port=3306;dbname=botdb';
        $user = getenv('DB_USER') ?: 'root';
        $pass = getenv('DB_PASS') ?: 'mysqlpassword';
        $this->pdo = new PDO($dsn, $user, $pass, [PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION]);
        $this->initializeDB();
    }

    private function initializeDB() {
        $this->pdo->exec("CREATE TABLE IF NOT EXISTS users (
            chat_id BIGINT PRIMARY KEY,
            username VARCHAR(255),
            balance DOUBLE DEFAULT 0,
            total_referrals INT DEFAULT 0,
            ref_code VARCHAR(10) UNIQUE,
            last_ad_watch INT DEFAULT 0,
            ads_watched_today INT DEFAULT 0,
            last_daily_reset VARCHAR(10),
            ton_address VARCHAR(255) DEFAULT '',
            total_earned DOUBLE DEFAULT 0,
            created_at INT,
            referred_by VARCHAR(10),
            max_balance DOUBLE DEFAULT 0,
            channel_joined TINYINT(1) DEFAULT 0,
            updated_at INT,
            awaiting_ton_address TINYINT(1) DEFAULT 0
        )");

        $this->pdo->exec("CREATE TABLE IF NOT EXISTS referrals (
            id INT AUTO_INCREMENT PRIMARY KEY,
            referrer_chat_id BIGINT,
            referred_chat_id BIGINT,
            referred_username VARCHAR(255),
            level INT DEFAULT 1,
            earned_amount DOUBLE DEFAULT 0,
            created_at INT
        )");

        $this->pdo->exec("CREATE TABLE IF NOT EXISTS transactions (
            id INT AUTO_INCREMENT PRIMARY KEY,
            chat_id BIGINT,
            type VARCHAR(50),
            amount DOUBLE,
            description TEXT,
            created_at INT
        )");

        $this->pdo->exec("CREATE TABLE IF NOT EXISTS withdrawals (
            id INT AUTO_INCREMENT PRIMARY KEY,
            chat_id BIGINT,
            amount DOUBLE,
            ton_address VARCHAR(255),
            status VARCHAR(20) DEFAULT 'pending',
            created_at INT,
            processed_at INT
        )");

        $this->pdo->exec("CREATE TABLE IF NOT EXISTS ad_watches (
            id INT AUTO_INCREMENT PRIMARY KEY,
            chat_id BIGINT,
            reward_amount DOUBLE,
            watch_time INT,
            created_at INT
        )");
    }

    public function getUser($chat_id) {
        $stmt = $this->pdo->prepare("SELECT * FROM users WHERE chat_id = ?");
        $stmt->execute([$chat_id]);
        return $stmt->fetch(PDO::FETCH_ASSOC);
    }

    public function createUser($user_data) {
        $stmt = $this->pdo->prepare("INSERT INTO users (chat_id, username, ref_code, created_at, updated_at) VALUES (?, ?, ?, ?, ?)");
        return $stmt->execute([
            $user_data['chat_id'],
            $user_data['username'],
            $user_data['ref_code'],
            time(),
            time()
        ]);
    }

    public function updateUser($chat_id, $update_data) {
        $fields = [];
        $values = [];
        foreach ($update_data as $key => $value) {
            $fields[] = "$key = ?";
            $values[] = $value;
        }
        $values[] = time();
        $values[] = $chat_id;
        $stmt = $this->pdo->prepare("UPDATE users SET " . implode(', ', $fields) . ", updated_at = ? WHERE chat_id = ?");
        return $stmt->execute($values);
    }

    public function addTransaction($chat_id, $type, $amount, $description) {
        $stmt = $this->pdo->prepare("INSERT INTO transactions (chat_id, type, amount, description, created_at) VALUES (?, ?, ?, ?, ?)");
        return $stmt->execute([$chat_id, $type, $amount, $description, time()]);
    }

    public function addAdWatch($chat_id, $reward_amount) {
        $stmt = $this->pdo->prepare("INSERT INTO ad_watches (chat_id, reward_amount, watch_time, created_at) VALUES (?,
