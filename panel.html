<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashReward Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f1f5f9; }
        .admin-page { display: none; }
        .admin-page.active { display: block; animation: fadeIn 0.5s; }
        .sidebar-link { transition: all 0.2s; }
        .sidebar-link.active, .sidebar-link:hover { background-color: #f97316; color: white; }
        .stat-card { background: white; border-radius: 0.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .input-field { border: 1px solid #cbd5e1; padding: 0.5rem 0.75rem; border-radius: 0.375rem; width: 100%; }
        .btn-primary { background-color: #f97316; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 600; }
        .btn-secondary { background-color: #64748b; color: white; }
        .btn-danger { background-color: #dc2626; color: white; }
        #toast-notification { transition: opacity 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>
    <!-- Loader -->
    <div id="loader" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-orange-500"></div>
    </div>
    
    <!-- Login Section -->
    <div id="auth-section" class="min-h-screen flex items-center justify-center bg-gray-100">
        <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Admin Panel Login</h2>
            <input id="login-email" type="email" placeholder="Email" class="input-field mb-4">
            <input id="login-password" type="password" placeholder="Password" class="input-field mb-4">
            <button id="login-btn" class="btn-primary w-full">Login</button>
            <p id="login-error" class="text-red-500 text-sm mt-2 text-center"></p>
        </div>
    </div>

    <!-- Main Admin Panel -->
    <div id="panel-section" class="hidden">
        <div class="flex h-screen bg-gray-100">
            <!-- Sidebar -->
            <aside class="w-64 bg-gray-800 text-gray-200 flex-shrink-0">
                <div class="p-4 text-2xl font-bold text-white">CashReward</div>
                <nav class="mt-6">
                    <a href="#" data-page="dashboard" class="sidebar-link active flex items-center py-3 px-4"><i data-lucide="layout-dashboard" class="w-5 h-5 mr-3"></i>Dashboard</a>
                    <a href="#" data-page="users" class="sidebar-link flex items-center py-3 px-4"><i data-lucide="users" class="w-5 h-5 mr-3"></i>Users</a>
                    <a href="#" data-page="withdrawals" class="sidebar-link flex items-center py-3 px-4"><i data-lucide="banknote" class="w-5 h-5 mr-3"></i>Withdrawals</a>
                    <a href="#" data-page="settings" class="sidebar-link flex items-center py-3 px-4"><i data-lucide="settings" class="w-5 h-5 mr-3"></i>App Settings</a>
                </nav>
                <div class="absolute bottom-0 w-64 p-4">
                    <button id="logout-btn" class="w-full bg-red-600 text-white py-2 rounded-lg">Logout</button>
                </div>
            </aside>
            <!-- Main Content -->
            <main class="flex-1 p-6 overflow-y-auto">
                <div id="dashboard" class="admin-page active"></div>
                <div id="users" class="admin-page"></div>
                <div id="withdrawals" class="admin-page"></div>
                <div id="settings" class="admin-page"></div>
            </main>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast-notification" class="hidden fixed top-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg opacity-0">
        <p id="toast-message"></p>
    </div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "Apna code dale",
            authDomain: "Apna code dale",
            projectId: "Apna code dale",
            storageBucket: "Apna code dale",
            messagingSenderId: "Apna code dale",
            appId: "Apna code dale"
        };
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, collection, getDocs, writeBatch, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db).catch((err) => {
            if (err.code == 'failed-precondition') {
                console.warn('Firestore persistence failed: multiple tabs open.');
            } else if (err.code == 'unimplemented') {
                console.warn('Firestore persistence not available in this browser.');
            }
        });

        const loader = document.getElementById('loader');

        window.onload = () => {
            lucide.createIcons();
            setupEventListeners();
            onAuthStateChanged(auth, handleAuthStateChange);
        };

        function handleAuthStateChange(user) {
            if (user) {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('panel-section').style.display = 'block';
                navigateTo('dashboard');
            } else {
                document.getElementById('auth-section').style.display = 'flex';
                document.getElementById('panel-section').style.display = 'none';
            }
        }

        function setupEventListeners() {
            document.getElementById('login-btn').addEventListener('click', handleLogin);
            document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    navigateTo(link.dataset.page);
                });
            });
        }
        
        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const errorEl = document.getElementById('login-error');
            errorEl.textContent = '';
            loader.style.display = 'flex';
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                errorEl.textContent = "Invalid email or password.";
            } finally {
                loader.style.display = 'none';
            }
        }
        
        function navigateTo(pageId) {
            document.querySelectorAll('.admin-page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-page="${pageId}"]`).classList.add('active');

            if (pageId === 'dashboard') loadDashboard();
            if (pageId === 'users') loadUsers();
            if (pageId === 'withdrawals') loadWithdrawals();
            if (pageId === 'settings') loadSettings();
        }

        async function loadDashboard() {
            const page = document.getElementById('dashboard');
            page.innerHTML = `<h1 class="text-3xl font-bold mb-6">Dashboard</h1><div id="stats-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6">Loading...</div>`;
            const usersSnap = await getDocs(collection(db, "users"));
            const withdrawalsSnap = await getDocs(collection(db, "withdrawals"));
            const pendingWithdrawals = withdrawalsSnap.docs.filter(d => d.data().status === 'pending').length;
            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-card p-6"><h3 class="text-gray-500">Total Users</h3><p class="text-3xl font-bold">${usersSnap.size}</p></div>
                <div class="stat-card p-6"><h3 class="text-gray-500">Total Withdrawals</h3><p class="text-3xl font-bold">${withdrawalsSnap.size}</p></div>
                <div class="stat-card p-6"><h3 class="text-gray-500">Pending Withdrawals</h3><p class="text-3xl font-bold text-orange-500">${pendingWithdrawals}</p></div>
            `;
        }

        async function loadUsers() {
            const page = document.getElementById('users');
            page.innerHTML = `<h1 class="text-3xl font-bold mb-6">Users</h1><div class="bg-white shadow rounded-lg p-4"><div class="overflow-x-auto">Loading...</div></div>`;
            const usersSnap = await getDocs(collection(db, "users"));
            let tableHTML = `<table class="w-full text-sm text-left text-gray-600 table-fixed">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>
                    <th class="px-6 py-3 w-1/3">Name</th><th class="px-6 py-3 w-1/3">Email</th><th class="px-6 py-3 w-1/6">Balance</th><th class="px-6 py-3 w-1/6">Actions</th>
                </tr></thead><tbody>`;
            usersSnap.forEach(doc => {
                const user = doc.data();
                tableHTML += `<tr class="bg-white border-b">
                    <td class="px-6 py-4 truncate">${user.name}</td>
                    <td class="px-6 py-4 truncate">${user.email}</td>
                    <td class="px-6 py-4 font-semibold">${user.balance || 0}</td>
                    <td class="px-6 py-4">
                        <button data-uid="${user.uid}" data-blocked="${user.isBlocked || false}" class="block-btn ${user.isBlocked ? 'btn-secondary' : 'btn-danger'} text-xs px-2 py-1 rounded w-full">${user.isBlocked ? 'Unblock' : 'Block'}</button>
                    </td>
                </tr>`;
            });
            tableHTML += `</tbody></table>`;
            page.querySelector('.overflow-x-auto').innerHTML = tableHTML;
            document.querySelectorAll('.block-btn').forEach(btn => btn.addEventListener('click', toggleUserBlock));
        }

        async function toggleUserBlock(e) {
            const { uid, blocked } = e.target.dataset;
            const isBlocked = blocked === 'true';
            loader.style.display = 'flex';
            await updateDoc(doc(db, "users", uid), { isBlocked: !isBlocked });
            loader.style.display = 'none';
            showToast(`User ${!isBlocked ? 'blocked' : 'unblocked'} successfully!`);
            loadUsers();
        }

        async function loadWithdrawals() {
            const page = document.getElementById('withdrawals');
            page.innerHTML = `<h1 class="text-3xl font-bold mb-6">Withdrawal Requests</h1><div class="bg-white shadow rounded-lg p-4"><div class="overflow-x-auto">Loading...</div></div>`;
            const withdrawalsSnap = await getDocs(collection(db, "withdrawals"));
            const pending = withdrawalsSnap.docs.filter(d => d.data().status === 'pending');

            if(pending.length === 0) {
                 page.querySelector('.overflow-x-auto').innerHTML = `<p class="text-center p-4">No pending requests.</p>`;
                 return;
            }

            let tableHTML = `<table class="w-full text-sm text-left text-gray-600 table-fixed">
                <thead class="text-xs text-gray-700 uppercase bg-gray-50"><tr>
                    <th class="px-6 py-3 w-1/4">User</th><th class="px-6 py-3 w-1/6">Amount</th><th class="px-6 py-3 w-1/6">Method</th><th class="px-6 py-3 w-1/4">Details</th><th class="px-6 py-3 w-auto">Actions</th>
                </tr></thead><tbody>`;
            pending.forEach(doc => {
                const req = doc.data();
                tableHTML += `<tr class="bg-white border-b">
                    <td class="px-6 py-4 truncate">${req.userName}</td>
                    <td class="px-6 py-4 font-semibold">${req.amount}</td>
                    <td class="px-6 py-4">${req.method}</td>
                    <td class="px-6 py-4 truncate">${req.paymentDetail}</td>
                    <td class="px-6 py-4 flex flex-nowrap gap-2">
                        <button data-docid="${doc.id}" class="process-btn bg-green-500 text-white text-xs px-2 py-1 rounded" data-action="approved">Approve</button>
                        <button data-docid="${doc.id}" data-uid="${req.userId}" data-amount="${req.amount}" class="process-btn btn-danger text-xs px-2 py-1 rounded" data-action="rejected">Reject</button>
                    </td>
                </tr>`;
            });
            tableHTML += `</tbody></table>`;
            page.querySelector('.overflow-x-auto').innerHTML = tableHTML;
            document.querySelectorAll('.process-btn').forEach(btn => btn.addEventListener('click', processWithdrawal));
        }
        
        async function processWithdrawal(e) {
            const { docid, action, uid, amount } = e.target.dataset;
            if (!docid || !action) return;
            
            loader.style.display = 'flex';
            const batch = writeBatch(db);
            const withdrawalRef = doc(db, "withdrawals", docid);
            batch.update(withdrawalRef, { status: action });

            if (action === 'rejected' && uid && amount) {
                const userRef = doc(db, "users", uid);
                try {
                    const userSnap = await getDoc(userRef);
                    if (userSnap.exists()) {
                        const currentBalance = userSnap.data().balance || 0;
                        batch.update(userRef, { balance: currentBalance + parseInt(amount) });
                    } else {
                        console.error(`User with UID ${uid} not found. Cannot refund coins.`);
                        showToast(`Warning: User ${uid} not found, could not refund coins.`, true);
                    }
                } catch (error) {
                    console.error("Error fetching user for refund:", error);
                }
            }
            await batch.commit();
            loader.style.display = 'none';
            showToast(`Withdrawal request has been ${action}.`);
            loadWithdrawals();
        }
        
        async function loadSettings() {
            const page = document.getElementById('settings');
            page.innerHTML = `<h1 class="text-3xl font-bold mb-6">App Settings</h1><div>Loading...</div>`;
            const configSnap = await getDoc(doc(db, "config", "main"));
            const config = configSnap.data() || {};
            renderSettings(config);
        }

        function renderSettings(config) {
             const page = document.getElementById('settings');
             page.innerHTML = `
                <h1 class="text-3xl font-bold mb-6">App Settings</h1>
                <div class="space-y-8">
                    <div class="bg-white p-6 rounded-lg shadow"><h2 class="text-xl font-bold mb-4">General & Payment</h2><div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="font-semibold">Min Withdrawal</label><input type="number" id="minWithdrawal" class="input-field" value="${config.minWithdrawal || 0}"></div>
                        <div><label class="font-semibold">Ad Watch Reward</label><input type="number" id="adWatchReward" class="input-field" value="${config.adWatchReward || 0}"></div>
                        <div><label class="font-semibold">Color Game Reward</label><input type="number" id="colorGameReward" class="input-field" value="${config.colorGameReward || 0}"></div>
                        <div><label class="font-semibold">Payment Methods (comma separated)</label><input type="text" id="paymentMethods" class="input-field" value="${(config.paymentMethods || []).join(',')}"></div>
                    </div></div>
                    <div class="bg-white p-6 rounded-lg shadow"><h2 class="text-xl font-bold mb-4">Special Ad Click Task</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="font-semibold">Show after # Ads</label><input type="number" id="watchAdSpecialTaskCount" class="input-field" value="${config.watchAdSpecialTaskCount || 0}"></div><div><label class="font-semibold">Task Reward</label><input type="number" id="watchAdSpecialTaskReward" class="input-field" value="${config.watchAdSpecialTaskReward || 0}"></div><div><label class="font-semibold">Wait Timer (seconds)</label><input type="number" id="watchAdSpecialTaskTimer" class="input-field" value="${config.watchAdSpecialTaskTimer || 0}"></div></div></div>
                    <div class="bg-white p-6 rounded-lg shadow"><h2 class="text-xl font-bold mb-4">Referral System</h2><div><label class="font-semibold">Referral Bonus</label><input type="number" id="referralBonus" class="input-field mb-4" value="${config.referralBonus || 0}"></div><div><label class="font-semibold">Referral Rules (one per line)</label><textarea id="referralRules" class="input-field h-24 mb-4">${(config.referralRules || []).join('\n')}</textarea></div><div><label class="font-semibold">Share Text ({CODE} & {APP_LINK})</label><textarea id="referralShareText" class="input-field h-24">${config.referralShareText || ''}</textarea></div></div>
                    <div id="dynamic-lists"></div>
                </div>
                <button id="save-settings-btn" class="btn-primary mt-8 px-8 py-3">Save All Settings</button>
            `;
            
            renderListEditor('sliderBanners', config.sliderBanners, ['img', 'link']);
            renderListEditor('websitesToVisit', config.websitesToVisit, ['name', 'link', 'reward', 'timer']);
            renderListEditor('socialTasks', config.socialTasks, ['name', 'link', 'icon', 'reward']);
            
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
        }

        function renderListEditor(key, items, fields) {
            const container = document.getElementById('dynamic-lists');
            let listHTML = `<div class="bg-white p-6 rounded-lg shadow mb-8"><h2 class="text-xl font-bold mb-4 capitalize">${key.replace(/([A-Z])/g, ' $1')}</h2><div id="${key}-list" class="space-y-2">`;
            (items || []).forEach((item, index) => {
                listHTML += `<div class="flex gap-2 items-center border p-2 rounded">`;
                fields.forEach(field => {
                    let placeholder = field;
                    if (key === 'socialTasks' && field === 'icon') {
                        placeholder = 'icon name or image URL';
                    }
                    listHTML += `<input type="text" class="input-field text-sm" placeholder="${placeholder}" data-key="${key}" data-index="${index}" data-field="${field}" value="${item[field] || ''}">`;
                });
                listHTML += `<button class="remove-item-btn text-red-500 font-bold text-xl p-1" data-key="${key}" data-index="${index}">&times;</button></div>`;
            });
            listHTML += `</div><button class="add-item-btn mt-4 text-sm btn-primary" data-key="${key}">+ Add New</button></div>`;
            container.innerHTML += listHTML;

            document.querySelectorAll('.add-item-btn, .remove-item-btn').forEach(btn => {
                btn.removeEventListener('click', handleListEdit);
                btn.addEventListener('click', handleListEdit);
            });
        }
        
        function handleListEdit(e) {
            const newConfig = getSettingsFromUI();
            const { key, index } = e.target.dataset;
            
            if (e.target.classList.contains('add-item-btn')) {
                if(!newConfig[key]) newConfig[key] = [];
                newConfig[key].push({});
            } else {
                newConfig[key].splice(index, 1);
            }
            renderSettings(newConfig);
        }

        function getSettingsFromUI() {
            const newConfig = {};
            ['minWithdrawal', 'adWatchReward', 'colorGameReward', 'watchAdSpecialTaskCount', 'watchAdSpecialTaskReward', 'watchAdSpecialTaskTimer', 'referralBonus'].forEach(id => {
                const el = document.getElementById(id);
                if (el) newConfig[id] = parseInt(el.value);
            });
            
            newConfig.paymentMethods = document.getElementById('paymentMethods').value.split(',').map(s => s.trim());
            newConfig.referralRules = document.getElementById('referralRules').value.split('\n').map(s => s.trim());
            newConfig.referralShareText = document.getElementById('referralShareText').value;

            ['sliderBanners', 'websitesToVisit', 'socialTasks'].forEach(key => {
                const listContainer = document.getElementById(`${key}-list`);
                if (!listContainer) return;
                newConfig[key] = [];
                const items = listContainer.children;
                for (let i = 0; i < items.length; i++) {
                    const inputs = items[i].querySelectorAll('input');
                    const newItem = {};
                    inputs.forEach(input => {
                        const value = input.value;
                        const numericFields = ['reward', 'timer'];
                        if (numericFields.includes(input.dataset.field) && !isNaN(value) && value.trim() !== '') {
                            newItem[input.dataset.field] = parseInt(value);
                        } else {
                            newItem[input.dataset.field] = value;
                        }
                    });
                    newConfig[key].push(newItem);
                }
            });
            return newConfig;
        }

        async function saveSettings() {
            const newConfig = getSettingsFromUI();
            loader.style.display = 'flex';
            try {
                await updateDoc(doc(db, "config", "main"), newConfig);
                showToast('Settings saved successfully!');
            } catch (error) {
                showToast('Error: Could not save settings.', true);
                console.error("Error saving settings:", error);
            } finally {
                loader.style.display = 'none';
            }
        }
        
        function showToast(message, isError = false) {
            const toast = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            if(!toast || !toastMessage) return;

            toastMessage.textContent = message;
            toast.className = `fixed top-5 right-5 text-white px-6 py-3 rounded-lg shadow-lg opacity-0 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
            
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.remove('opacity-0'), 50);

            setTimeout(() => {
                toast.classList.add('opacity-0');
                setTimeout(() => {
                    toast.classList.add('hidden');
                }, 500);
            }, 3000);
        }
        
    </script>
</body>
</html>
